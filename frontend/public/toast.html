<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Itero — Task Complete</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Trello SDK -->
  <script src="https://p.trellocdn.com/power-up.min.js"></script>

  <!-- Use Itero tokens + toast layout styles -->
  <link rel="stylesheet" href="/itero-theme.css" />
  <link rel="stylesheet" href="/toast.css" />
</head>
<body>
  <div class="itero-toast" role="dialog" aria-label="Task Completed">
    <div class="itero-row">
      <div class="itero-logo">
        <img src="/assets/itero-icon-w-24.png" alt="Itero" />
      </div>
      <div class="itero-head">
        <h2 class="itero-title">Task Completed</h2>
        <p class="itero-sub">Nice work — here’s what you earned</p>
      </div>
      <button id="openDash" class="itero-btn itero-btn--primary" aria-label="Open dashboard">
        Open&nbsp;Dashboard
      </button>
    </div>

    <div class="itero-panel">
      <div class="itero-pillbar" id="pillbar"></div>
    </div>

    <div class="itero-actions">
      <button id="closeBtn" class="itero-btn" aria-label="Close">Close</button>
    </div>
  </div>

  <script>
    (function () {
      const t = window.TrelloPowerUp?.iframe();
      const q = new URLSearchParams(location.search);

      const xp = Number(q.get('xp') || 0);
      const level = q.get('level') || '?';
      const streak = Number(q.get('streak') || 0);
      const done = Number(q.get('done') || 0);
      const note = q.get('note') || '';

      if (note === 'already') {
        document.querySelector('.itero-title').textContent = 'Already Completed';
        document.querySelector('.itero-sub').textContent = 'This task was previously marked done.';
      }

      const pills = [
        { emoji: '🎉', label: 'XP', value: `+${xp}` },
        { emoji: '🏅', label: 'Level', value: `${level}` },
        { emoji: '🔥', label: 'Streak', value: `${streak}-day` },
      ];
      if (done > 0) pills.push({ emoji: '🏆', label: 'Challenges', value: `${done} completed` });

      const wrap = document.getElementById('pillbar');
      pills.forEach(p => {
        const el = document.createElement('div');
        el.className = 'itero-pill';
        el.innerHTML = `${p.emoji} ${p.label}: <b>${p.value}</b>`;
        wrap.appendChild(el);
      });

      document.getElementById('openDash').addEventListener('click', async () => {
        try {
          const primary = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2f6aa6';
          await t.modal({
            url: '/index.html#/dashboard',
            title: 'Itero Dashboard',
            height: 620,
            fullscreen: false,
            accentColor: primary
          });
        } finally {
          t.closePopup();
        }
      });

      document.getElementById('closeBtn').addEventListener('click', () => t.closePopup());
      window.addEventListener('keydown', (e) => e.key === 'Escape' && t.closePopup());

      // auto-dismiss after 4.5s
      setTimeout(() => t.closePopup(), 4500);
    })();
  </script>
</body>
</html>
