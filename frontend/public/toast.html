<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Itero â€” Task Complete</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Trello Power-Up SDK -->
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <link rel="stylesheet" href="/toast.css" />
</head>
<body>
  <div class="itero-toast" role="dialog" aria-label="Task Completed">
    <div class="itero-row">
      <div class="itero-logo">
        <img src="/assets/itero-icon-w-24.png" alt="Itero" />
      </div>

      <div class="itero-head">
        <h2 class="itero-title">Task Completed</h2>
        <p class="itero-sub">Nice work â€” hereâ€™s what you earned</p>
      </div>

      <button id="openDash" class="itero-btn itero-btn--primary" aria-label="Open dashboard">
        Open&nbsp;Dashboard
      </button>
    </div>

    <div id="pill-section" class="itero-panel">
      <div class="itero-pillbar" id="pillbar"></div>
    </div>

    <div class="itero-actions">
      <button id="closeBtn" class="itero-btn" aria-label="Close">Close</button>
    </div>
  </div>

  <script>
    (function () {
      const t = window.TrelloPowerUp?.iframe();
      const q = new URLSearchParams(location.search);

      const xp = Number(q.get('xp') || 0);
      const level = q.get('level') || '?';
      const streak = Number(q.get('streak') || 0);
      const done = Number(q.get('done') || 0);
      const note = q.get('note') || '';

      const titleEl = document.querySelector('.itero-title');
      const subEl = document.querySelector('.itero-sub');
      const pillSection = document.getElementById('pill-section');
      const pillbar = document.getElementById('pillbar');

      if (note === 'already') {
        titleEl.textContent = 'Already Completed';
        subEl.textContent = 'This task was previously marked done.';
        pillSection.style.display = 'none'; // âœ… hide achievements section
      } else {
        const pills = [
          { emoji: 'ðŸŽ‰', label: 'XP', value: `+${xp}` },
          { emoji: 'ðŸ…', label: 'Level', value: `${level}` },
          { emoji: 'ðŸ”¥', label: 'Streak', value: `${streak}-day` },
        ];
        if (done > 0) pills.push({ emoji: 'ðŸ†', label: 'Challenges', value: `${done} completed` });

        pills.forEach(p => {
          const el = document.createElement('div');
          el.className = 'itero-pill';
          el.innerHTML = `${p.emoji} ${p.label}: <b>${p.value}</b>`;
          pillbar.appendChild(el);
        });
      }

      document.getElementById('openDash').addEventListener('click', async () => {
        try {
          await t.modal({
            url: '/index.html#/dashboard',
            title: 'Itero Dashboard',
            height: 620,
            fullscreen: false,
            accentColor: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2f6aa6'
          });
        } finally {
          t.closePopup();
        }
      });

      document.getElementById('closeBtn').addEventListener('click', () => t.closePopup());
      window.addEventListener('keydown', (e) => e.key === 'Escape' && t.closePopup());
      setTimeout(() => t.closePopup(), 4500);
    })();
  </script>
</body>
</html>
