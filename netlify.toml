###############################################
# Itero Power-Up — Netlify Configuration
###############################################

[build]
  base = "frontend"
  command = "npm run build"
  publish = "dist"

###############################################
# Redirects
###############################################

# Allow these files to load directly (avoid redirect to SPA)
[[redirects]]
  from = "/popup.html"
  to = "/popup.html"
  status = 200

[[redirects]]
  from = "/powerup.js"
  to = "/powerup.js"
  status = 200

[[redirects]]
  from = "/dashboard-wrapper.html"
  to = "/dashboard-wrapper.html"
  status = 200

[[redirects]]
  from = "/settings.html"
  to = "/settings.html"
  status = 200

# Catch-all SPA rule (keep last)
[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200

###############################################
# Default headers
###############################################

[[headers]]
  for = "/*"
  [headers.values]
    Strict-Transport-Security = "max-age=63072000; includeSubDomains; preload"
    X-Content-Type-Options    = "nosniff"
    Referrer-Policy           = "strict-origin-when-cross-origin"
    Permissions-Policy        = "camera=(), microphone=(), geolocation=()"

[[headers]]
  for = "/powerup.js"
  [headers.values]
    Content-Type = "application/javascript; charset=utf-8"

[[headers]]
  for = "/popup.html"
  [headers.values]
    Content-Type = "text/html; charset=utf-8"

###############################################
# Security Headers — Production
###############################################

[context.production]
  [[context.production.headers]]
    for = "/*"
    [context.production.headers.values]
      Content-Security-Policy = """
default-src 'self';
frame-ancestors https://trello.com https://*.trello.com;
script-src 'self' https://p.trellocdn.com;
script-src-elem 'self' https://p.trellocdn.com;
style-src 'self' 'unsafe-inline';
img-src 'self' data: https:;
font-src 'self' data: https:;
connect-src 'self' https://api.trello.com https://itero-api-fme7.onrender.com;
object-src 'none';
base-uri 'none';
form-action 'self';
upgrade-insecure-requests
"""

###############################################
# Security Headers — Dev Branch: dev
###############################################

[context."dev"]
  [[context."dev".headers]]
    for = "/*"
    [context."dev".headers.values]
      Content-Security-Policy = """
default-src 'self';
frame-ancestors https://trello.com https://*.trello.com;
script-src 'self' https://p.trellocdn.com;
script-src-elem 'self' https://p.trellocdn.com;
style-src 'self' 'unsafe-inline';
img-src 'self' data: https:;
font-src 'self' data: https:;
connect-src 'self' https://api.trello.com https://itero-api-dev.onrender.com https://itero-api-dev-zg94.onrender.com;
object-src 'none';
base-uri 'none';
form-action 'self';
upgrade-insecure-requests
"""

###############################################
# Security Headers — Deploy Previews
###############################################

[context.deploy-preview]
  [[context.deploy-preview.headers]]
    for = "/*"
    [context.deploy-preview.headers.values]
      Content-Security-Policy = """
default-src 'self';
frame-ancestors https://trello.com https://*.trello.com;
script-src 'self' https://p.trellocdn.com;
script-src-elem 'self' https://p.trellocdn.com;
style-src 'self' 'unsafe-inline';
img-src 'self' data: https:;
font-src 'self' data: https:;
connect-src 'self' https://api.trello.com https://itero-api-dev.onrender.com https://itero-api-dev-zg94.onrender.com;
object-src 'none';
base-uri 'none';
form-action 'self';
upgrade-insecure-requests
"""
